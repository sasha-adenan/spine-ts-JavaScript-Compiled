/******************************************************************************
 * Spine Runtimes License Agreement
 * Last updated April 5, 2025. Replaces all prior versions.
 *
 * Copyright (c) 2013-2025, Esoteric Software LLC
 *
 * Integration of the Spine Runtimes into software or otherwise creating
 * derivative works of the Spine Runtimes is permitted under the terms and
 * conditions of Section 2 of the Spine Editor License Agreement:
 * http://esotericsoftware.com/spine-editor-license
 *
 * Otherwise, it is permitted to integrate the Spine Runtimes into software
 * or otherwise create derivative works of the Spine Runtimes (collectively,
 * "Products"), provided that each user of the Products must obtain their own
 * Spine Editor license and redistribution of the Products in any form must
 * include this license and copyright notice.
 *
 * THE SPINE RUNTIMES ARE PROVIDED BY ESOTERIC SOFTWARE LLC "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL ESOTERIC SOFTWARE LLC BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES,
 * BUSINESS INTERRUPTION, OR LOSS OF USE, DATA, OR PROFITS) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THE SPINE RUNTIMES, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *****************************************************************************/
import { TextureAtlas } from '@esotericsoftware/spine-core';
import { checkExtension, copySearchParams, DOMAdapter, ExtensionType, extensions, LoaderParserPriority, path, Resolver, TextureSource, } from 'pixi.js';
import { SpineTexture } from '../SpineTexture.js';
const loaderName = "spineTextureAtlasLoader";
const spineTextureAtlasLoader = {
    extension: ExtensionType.Asset,
    resolver: {
        test: (value) => checkExtension(value, ".atlas"),
        parse: (value) => {
            const split = value.split('.');
            return {
                resolution: parseFloat(Resolver.RETINA_PREFIX?.exec(value)?.[1] ?? '1'),
                format: split[split.length - 2],
                src: value,
            };
        },
    },
    loader: {
        id: loaderName,
        name: loaderName,
        extension: {
            type: ExtensionType.LoadParser,
            priority: LoaderParserPriority.Normal,
            name: loaderName,
        },
        test(url) {
            return checkExtension(url, '.atlas');
        },
        async load(url) {
            const response = await DOMAdapter.get().fetch(url);
            const txt = await response.text();
            return txt;
        },
        testParse(asset, options) {
            const isExtensionRight = checkExtension(options.src, '.atlas');
            const isString = typeof asset === 'string';
            const isExplicitLoadParserSet = options.parser === loaderName || options.loadParser === loaderName;
            return Promise.resolve((isExtensionRight || isExplicitLoadParserSet) && isString);
        },
        unload(atlas) {
            atlas.dispose();
        },
        async parse(asset, options, loader) {
            const metadata = options.data || {};
            let basePath = path.dirname(options.src);
            if (basePath && basePath.lastIndexOf('/') !== basePath.length - 1) {
                basePath += '/';
            }
            // Retval is going to be a texture atlas. However we need to wait for it's callback to resolve this promise.
            const retval = new TextureAtlas(asset);
            // If the user gave me only one texture, that one is assumed to be the "first" texture in the atlas
            if (metadata.images instanceof TextureSource || typeof metadata.images === 'string') {
                const pixiTexture = metadata.images;
                metadata.images = {};
                metadata.images[retval.pages[0].name] = pixiTexture;
            }
            // we will wait for all promises for the textures at the same time at the end.
            const textureLoadingPromises = [];
            // fill the pages
            for (const page of retval.pages) {
                const pageName = page.name;
                const providedPage = metadata?.images ? metadata.images[pageName] : undefined;
                if (providedPage instanceof TextureSource) {
                    page.setTexture(SpineTexture.from(providedPage));
                }
                else {
                    // eslint-disable-next-line max-len
                    const url = providedPage ?? path.normalize([...basePath.split(path.sep), pageName].join(path.sep));
                    const assetsToLoadIn = {
                        src: copySearchParams(url, options.src),
                        data: {
                            ...metadata.imageMetadata,
                            alphaMode: page.pma ? 'premultiplied-alpha' : 'premultiply-alpha-on-upload'
                        }
                    };
                    const pixiPromise = loader.load(assetsToLoadIn).then((texture) => {
                        page.setTexture(SpineTexture.from(texture.source));
                    });
                    textureLoadingPromises.push(pixiPromise);
                }
            }
            await Promise.all(textureLoadingPromises);
            return retval;
        },
    },
};
extensions.add(spineTextureAtlasLoader);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXRsYXNMb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXNzZXRzL2F0bGFzTG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7K0VBMkIrRTtBQUUvRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDNUQsT0FBTyxFQUVOLGNBQWMsRUFDZCxnQkFBZ0IsRUFDaEIsVUFBVSxFQUNWLGFBQWEsRUFDYixVQUFVLEVBRVYsb0JBQW9CLEVBQ3BCLElBQUksRUFFSixRQUFRLEVBRVIsYUFBYSxHQUViLE1BQU0sU0FBUyxDQUFDO0FBQ2pCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUtsRCxNQUFNLFVBQVUsR0FBRyx5QkFBeUIsQ0FBQztBQUU3QyxNQUFNLHVCQUF1QixHQUFpRTtJQUM3RixTQUFTLEVBQUUsYUFBYSxDQUFDLEtBQUs7SUFFOUIsUUFBUSxFQUFFO1FBQ1QsSUFBSSxFQUFFLENBQUMsS0FBYSxFQUFXLEVBQUUsQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQztRQUNqRSxLQUFLLEVBQUUsQ0FBQyxLQUFhLEVBQW1CLEVBQUU7WUFDekMsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUUvQixPQUFPO2dCQUNOLFVBQVUsRUFBRSxVQUFVLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUM7Z0JBQ3ZFLE1BQU0sRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7Z0JBQy9CLEdBQUcsRUFBRSxLQUFLO2FBQ1YsQ0FBQztRQUNILENBQUM7S0FDRDtJQUVELE1BQU0sRUFBRTtRQUNQLEVBQUUsRUFBRSxVQUFVO1FBQ2QsSUFB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Q25DLE1BQU0sR0FBRyxHQUFXLFlBQVksSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBRTNHLE1BQU0sY0FBYyxHQUFHO3dCQUN0QixHQUFHLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFhLENBQUM7d0JBQ2pELElBQUksRUFBRTs0QkFDTCxHQUFHLFFBQVEsQ0FBQyxhQUFhOzRCQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLDZCQUE2Qjt5QkFDM0U7cUJBQ0QsQ0FBQztvQkFFRixNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFVLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO3dCQUN6RSxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ3BELENBQUMsQ0FBQyxDQUFDO29CQUVILHNCQUFzQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDMUMsQ0FBQztZQUNGLENBQUM7WUFFRCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztZQUUxQyxPQUFPLE1BQU0sQ0FBQztRQUNmLENBQUM7S0FDRDtDQUMrRCxDQUFDO0FBRWxFLFVBQVUsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqIFNwaW5lIFJ1bnRpbWVzIExpY2Vuc2UgQWdyZWVtZW50XG4gKiBMYXN0IHVwZGF0ZWQgQXByaWwgNSwgMjAyNS4gUmVwbGFjZXMgYWxsIHByaW9yIHZlcnNpb25zLlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMy0yMDI1LCBFc290ZXJpYyBTb2Z0d2FyZSBMTENcbiAqXG4gKiBJbnRlZ3JhdGlvbiBvZiB0aGUgU3BpbmUgUnVudGltZXMgaW50byBzb2Z0d2FyZSBvciBvdGhlcndpc2UgY3JlYXRpbmdcbiAqIGRlcml2YXRpdmUgd29ya3Mgb2YgdGhlIFNwaW5lIFJ1bnRpbWVzIGlzIHBlcm1pdHRlZCB1bmRlciB0aGUgdGVybXMgYW5kXG4gKiBjb25kaXRpb25zIG9mIFNlY3Rpb24gMiBvZiB0aGUgU3BpbmUgRWRpdG9yIExpY2Vuc2UgQWdyZWVtZW50OlxuICogaHR0cDovL2Vzb3Rlcmljc29mdHdhcmUuY29tL3NwaW5lLWVkaXRvci1saWNlbnNlXG4gKlxuICogT3RoZXJ3aXNlLCBpdCBpcyBwZXJtaXR0ZWQgdG8gaW50ZWdyYXRlIHRoZSBTcGluZSBSdW50aW1lcyBpbnRvIHNvZnR3YXJlXG4gKiBvciBvdGhlcndpc2UgY3JlYXRlIGRlcml2YXRpdmUgd29ya3Mgb2YgdGhlIFNwaW5lIFJ1bnRpbWVzIChjb2xsZWN0aXZlbHksXG4gKiBcIlByb2R1Y3RzXCIpLCBwcm92aWRlZCB0aGF0IGVhY2ggdXNlciBvZiB0aGUgUHJvZHVjdHMgbXVzdCBvYnRhaW4gdGhlaXIgb3duXG4gKiBTcGluZSBFZGl0b3IgbGljZW5zZSBhbmQgcmVkaXN0cmlidXRpb24gb2YgdGhlIFByb2R1Y3RzIGluIGFueSBmb3JtIG11c3RcbiAqIGluY2x1ZGUgdGhpcyBsaWNlbnNlIGFuZCBjb3B5cmlnaHQgbm90aWNlLlxuICpcbiAqIFRIRSBTUElORSBSVU5USU1FUyBBUkUgUFJPVklERUQgQlkgRVNPVEVSSUMgU09GVFdBUkUgTExDIFwiQVMgSVNcIiBBTkQgQU5ZXG4gKiBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBFU09URVJJQyBTT0ZUV0FSRSBMTEMgQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVMsXG4gKiBCVVNJTkVTUyBJTlRFUlJVUFRJT04sIE9SIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0ZcbiAqIFRIRSBTUElORSBSVU5USU1FUywgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuaW1wb3J0IHsgVGV4dHVyZUF0bGFzIH0gZnJvbSAnQGVzb3Rlcmljc29mdHdhcmUvc3BpbmUtY29yZSc7XG5pbXBvcnQge1xuXHR0eXBlIEFzc2V0RXh0ZW5zaW9uLFxuXHRjaGVja0V4dGVuc2lvbixcblx0Y29weVNlYXJjaFBhcmFtcyxcblx0RE9NQWRhcHRlcixcblx0RXh0ZW5zaW9uVHlwZSxcblx0ZXh0ZW5zaW9ucyxcblx0dHlwZSBMb2FkZXIsXG5cdExvYWRlclBhcnNlclByaW9yaXR5LFxuXHRwYXRoLFxuXHR0eXBlIFJlc29sdmVkQXNzZXQsXG5cdFJlc29sdmVyLFxuXHR0eXBlIFRleHR1cmUsXG5cdFRleHR1cmVTb3VyY2UsXG5cdHR5cGUgVW5yZXNvbHZlZEFzc2V0LFxufSBmcm9tICdwaXhpLmpzJztcbmltcG9ydCB7IFNwaW5lVGV4dHVyZSB9IGZyb20gJy4uL1NwaW5lVGV4dHVyZS5qcyc7XG5cblxudHlwZSBSYXdBdGxhcyA9IHN0cmluZztcblxuY29uc3QgbG9hZGVyTmFtZSA9IFwic3BpbmVUZXh0dXJlQXRsYXNMb2FkZXJcIjtcblxuY29uc3Qgc3BpbmVUZXh0dXJlQXRsYXNMb2FkZXI6IEFzc2V0RXh0ZW5zaW9uPFJhd0F0bGFzIHwgVGV4dHVyZUF0bGFzLCBJU3BpbmVBdGxhc01ldGFkYXRhPiA9IHtcblx0ZXh0ZW5zaW9uOiBFeHRlbnNpb25UeXBlLkFzc2V0LFxuXG5cdHJlc29sdmVyOiB7XG5cdFx0dGVzdDogKHZhbHVlOiBzdHJpbmcpOiBib29sZWFuID0+IGNoZWNrRXh0ZW5zaW9uKHZhbHVlLCBcIi5hdGxhc1wiKSxcblx0XHRwYXJzZTogKHZhbHVlOiBzdHJpbmcpOiBVbnJlc29sdmVkQXNzZXQgPT4ge1xuXHRcdFx0Y29uc3Qgc3BsaXQgPSB2YWx1ZS5zcGxpdCgnLicpO1xuXG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRyZXNvbHV0aW9uOiBwYXJzZUZsb2F0KFJlc29sdmVyLlJFVElOQV9QUkVGSVg/LmV4ZWModmFsdWUpPy5bMV0gPz8gJzEnKSxcblx0XHRcdFx0Zm9ybWF0OiBzcGxpdFtzcGxpdC5sZW5ndGggLSAyXSxcblx0XHRcdFx0c3JjOiB2YWx1ZSxcblx0XHRcdH07XG5cdFx0fSxcblx0fSxcblxuXHRsb2FkZXI6IHtcblx0XHRpZDogbG9hZGVyTmFtZSxcblx0XHRuYW1lOiBsb2FkZXJOYW1lLFxuXHRcdGV4dGVuc2lvbjoge1xuXHRcdFx0dHlwZTogRXh0ZW5zaW9uVHlwZS5Mb2FkUGFyc2VyLFxuXHRcdFx0cHJpb3JpdHk6IExvYWRlclBhcnNlclByaW9yaXR5Lk5vcm1hbCxcblx0XHRcdG5hbWU6IGxvYWRlck5hbWUsXG5cdFx0fSxcblxuXHRcdHRlc3QgKHVybDogc3RyaW5nKTogYm9vbGVhbiB7XG5cdFx0XHRyZXR1cm4gY2hlY2tFeHRlbnNpb24odXJsLCAnLmF0bGFzJyk7XG5cdFx0fSxcblxuXHRcdGFzeW5jIGxvYWQgKHVybDogc3RyaW5nKTogUHJvbWlzZTxSYXdBdGxhcz4ge1xuXHRcdFx0Y29uc3QgcmVzcG9uc2UgPSBhd2FpdCBET01BZGFwdGVyLmdldCgpLmZldGNoKHVybCk7XG5cblx0XHRcdGNvbnN0IHR4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcblxuXHRcdFx0cmV0dXJuIHR4dDtcblx0XHR9LFxuXG5cdFx0dGVzdFBhcnNlIChhc3NldDogdW5rbm93biwgb3B0aW9uczogUmVzb2x2ZWRBc3NldCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdFx0Y29uc3QgaXNFeHRlbnNpb25SaWdodCA9IGNoZWNrRXh0ZW5zaW9uKG9wdGlvbnMuc3JjIGFzIHN0cmluZywgJy5hdGxhcycpO1xuXHRcdFx0Y29uc3QgaXNTdHJpbmcgPSB0eXBlb2YgYXNzZXQgPT09ICdzdHJpbmcnO1xuXHRcdFx0Y29uc3QgaXNFeHBsaWNpdExvYWRQYXJzZXJTZXQgPSBvcHRpb25zLnBhcnNlciA9PT0gbG9hZGVyTmFtZSB8fCBvcHRpb25zLmxvYWRQYXJzZXIgPT09IGxvYWRlck5hbWU7XG5cblx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoKGlzRXh0ZW5zaW9uUmlnaHQgfHwgaXNFeHBsaWNpdExvYWRQYXJzZXJTZXQpICYmIGlzU3RyaW5nKTtcblx0XHR9LFxuXG5cdFx0dW5sb2FkIChhdGxhczogVGV4dHVyZUF0bGFzKSB7XG5cdFx0XHRhdGxhcy5kaXNwb3NlKCk7XG5cdFx0fSxcblxuXHRcdGFzeW5jIHBhcnNlIChhc3NldDogUmF3QXRsYXMsIG9wdGlvbnM6IFJlc29sdmVkQXNzZXQsIGxvYWRlcjogTG9hZGVyKTogUHJvbWlzZTxUZXh0dXJlQXRsYXM+IHtcblx0XHRcdGNvbnN0IG1ldGFkYXRhOiBJU3BpbmVBdGxhc01ldGFkYXRhID0gb3B0aW9ucy5kYXRhIHx8IHt9O1xuXHRcdFx0bGV0IGJhc2VQYXRoID0gcGF0aC5kaXJuYW1lKG9wdGlvbnMuc3JjIGFzIHN0cmluZyk7XG5cblx0XHRcdGlmIChiYXNlUGF0aCAmJiBiYXNlUGF0aC5sYXN0SW5kZXhPZignLycpICE9PSBiYXNlUGF0aC5sZW5ndGggLSAxKSB7XG5cdFx0XHRcdGJhc2VQYXRoICs9ICcvJztcblx0XHRcdH1cblxuXHRcdFx0Ly8gUmV0dmFsIGlzIGdvaW5nIHRvIGJlIGEgdGV4dHVyZSBhdGxhcy4gSG93ZXZlciB3ZSBuZWVkIHRvIHdhaXQgZm9yIGl0J3MgY2FsbGJhY2sgdG8gcmVzb2x2ZSB0aGlzIHByb21pc2UuXG5cdFx0XHRjb25zdCByZXR2YWwgPSBuZXcgVGV4dHVyZUF0bGFzKGFzc2V0KTtcblxuXHRcdFx0Ly8gSWYgdGhlIHVzZXIgZ2F2ZSBtZSBvbmx5IG9uZSB0ZXh0dXJlLCB0aGF0IG9uZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBcImZpcnN0XCIgdGV4dHVyZSBpbiB0aGUgYXRsYXNcblx0XHRcdGlmIChtZXRhZGF0YS5pbWFnZXMgaW5zdGFuY2VvZiBUZXh0dXJlU291cmNlIHx8IHR5cGVvZiBtZXRhZGF0YS5pbWFnZXMgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdGNvbnN0IHBpeGlUZXh0dXJlID0gbWV0YWRhdGEuaW1hZ2VzO1xuXG5cdFx0XHRcdG1ldGFkYXRhLmltYWdlcyA9IHt9IGFzIFJlY29yZDxzdHJpbmcsIFRleHR1cmVTb3VyY2UgfCBzdHJpbmc+O1xuXHRcdFx0XHRtZXRhZGF0YS5pbWFnZXNbcmV0dmFsLnBhZ2VzWzBdLm5hbWVdID0gcGl4aVRleHR1cmU7XG5cdFx0XHR9XG5cblx0XHRcdC8vIHdlIHdpbGwgd2FpdCBmb3IgYWxsIHByb21pc2VzIGZvciB0aGUgdGV4dHVyZXMgYXQgdGhlIHNhbWUgdGltZSBhdCB0aGUgZW5kLlxuXHRcdFx0Y29uc3QgdGV4dHVyZUxvYWRpbmdQcm9taXNlczogUHJvbWlzZTxhbnk+W10gPSBbXTtcblxuXHRcdFx0Ly8gZmlsbCB0aGUgcGFnZXNcblx0XHRcdGZvciAoY29uc3QgcGFnZSBvZiByZXR2YWwucGFnZXMpIHtcblx0XHRcdFx0Y29uc3QgcGFnZU5hbWUgPSBwYWdlLm5hbWU7XG5cdFx0XHRcdGNvbnN0IHByb3ZpZGVkUGFnZSA9IG1ldGFkYXRhPy5pbWFnZXMgPyBtZXRhZGF0YS5pbWFnZXNbcGFnZU5hbWVdIDogdW5kZWZpbmVkO1xuXG5cdFx0XHRcdGlmIChwcm92aWRlZFBhZ2UgaW5zdGFuY2VvZiBUZXh0dXJlU291cmNlKSB7XG5cdFx0XHRcdFx0cGFnZS5zZXRUZXh0dXJlKFNwaW5lVGV4dHVyZS5mcm9tKHByb3ZpZGVkUGFnZSkpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG5cdFx0XHRcdFx0Y29uc3QgdXJsOiBzdHJpbmcgPSBwcm92aWRlZFBhZ2UgPz8gcGF0aC5ub3JtYWxpemUoWy4uLmJhc2VQYXRoLnNwbGl0KHBhdGguc2VwKSwgcGFnZU5hbWVdLmpvaW4ocGF0aC5zZXApKTtcblxuXHRcdFx0XHRcdGNvbnN0IGFzc2V0c1RvTG9hZEluID0ge1xuXHRcdFx0XHRcdFx0c3JjOiBjb3B5U2VhcmNoUGFyYW1zKHVybCwgb3B0aW9ucy5zcmMgYXMgc3RyaW5nKSxcblx0XHRcdFx0XHRcdGRhdGE6IHtcblx0XHRcdFx0XHRcdFx0Li4ubWV0YWRhdGEuaW1hZ2VNZXRhZGF0YSxcblx0XHRcdFx0XHRcdFx0YWxwaGFNb2RlOiBwYWdlLnBtYSA/ICdwcmVtdWx0aXBsaWVkLWFscGhhJyA6ICdwcmVtdWx0aXBseS1hbHBoYS1vbi11cGxvYWQnXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fTtcblxuXHRcdFx0XHRcdGNvbnN0IHBpeGlQcm9taXNlID0gbG9hZGVyLmxvYWQ8VGV4dHVyZT4oYXNzZXRzVG9Mb2FkSW4pLnRoZW4oKHRleHR1cmUpID0+IHtcblx0XHRcdFx0XHRcdHBhZ2Uuc2V0VGV4dHVyZShTcGluZVRleHR1cmUuZnJvbSh0ZXh0dXJlLnNvdXJjZSkpO1xuXHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0dGV4dHVyZUxvYWRpbmdQcm9taXNlcy5wdXNoKHBpeGlQcm9taXNlKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRhd2FpdCBQcm9taXNlLmFsbCh0ZXh0dXJlTG9hZGluZ1Byb21pc2VzKTtcblxuXHRcdFx0cmV0dXJuIHJldHZhbDtcblx0XHR9LFxuXHR9LFxufSBhcyBBc3NldEV4dGVuc2lvbjxSYXdBdGxhcyB8IFRleHR1cmVBdGxhcywgSVNwaW5lQXRsYXNNZXRhZGF0YT47XG5cbmV4dGVuc2lvbnMuYWRkKHNwaW5lVGV4dHVyZUF0bGFzTG9hZGVyKTtcblxuZXhwb3J0IGludGVyZmFjZSBJU3BpbmVBdGxhc01ldGFkYXRhIHtcblx0Ly8gSWYgeW91IGFyZSBkb3dubG9hZGluZyBhbiAuYXRsYXMgZmlsZSwgdGhpcyBtZXRhZGF0YSB3aWxsIGdvIHRvIHRoZSBUZXh0dXJlIGxvYWRlclxuXHRpbWFnZU1ldGFkYXRhPzogYW55O1xuXHQvLyBJZiB5b3UgYWxyZWFkeSBoYXZlIGF0bGFzIHBhZ2VzIGxvYWRlZCBhcyBwaXhpIHRleHR1cmVzXG5cdC8vIGFuZCB3YW50IHRvIHVzZSB0aGF0IHRvIGNyZWF0ZSB0aGUgYXRsYXMsIHlvdSBjYW4gcGFzcyB0aGVtIGhlcmVcblx0aW1hZ2VzPzogVGV4dHVyZVNvdXJjZSB8IHN0cmluZyB8IFJlY29yZDxzdHJpbmcsIFRleHR1cmVTb3VyY2UgfCBzdHJpbmc+O1xufVxuIl19