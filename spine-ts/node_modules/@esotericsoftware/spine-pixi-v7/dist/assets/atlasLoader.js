/******************************************************************************
 * Spine Runtimes License Agreement
 * Last updated April 5, 2025. Replaces all prior versions.
 *
 * Copyright (c) 2013-2025, Esoteric Software LLC
 *
 * Integration of the Spine Runtimes into software or otherwise creating
 * derivative works of the Spine Runtimes is permitted under the terms and
 * conditions of Section 2 of the Spine Editor License Agreement:
 * http://esotericsoftware.com/spine-editor-license
 *
 * Otherwise, it is permitted to integrate the Spine Runtimes into software
 * or otherwise create derivative works of the Spine Runtimes (collectively,
 * "Products"), provided that each user of the Products must obtain their own
 * Spine Editor license and redistribution of the Products in any form must
 * include this license and copyright notice.
 *
 * THE SPINE RUNTIMES ARE PROVIDED BY ESOTERIC SOFTWARE LLC "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL ESOTERIC SOFTWARE LLC BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES,
 * BUSINESS INTERRUPTION, OR LOSS OF USE, DATA, OR PROFITS) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THE SPINE RUNTIMES, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *****************************************************************************/
import { TextureAtlas } from "@esotericsoftware/spine-core";
import { SpineTexture } from "../SpineTexture.js";
import { Assets, copySearchParams } from "@pixi/assets";
import { LoaderParserPriority, checkExtension } from "@pixi/assets";
import { ALPHA_MODES, ExtensionType, settings, utils, BaseTexture, extensions } from "@pixi/core";
const loaderName = "spineTextureAtlasLoader";
const spineTextureAtlasLoader = {
    extension: ExtensionType.Asset,
    resolver: {
        test: (value) => checkExtension(value, ".atlas"),
        parse: (value) => {
            const split = value.split('.');
            return {
                resolution: parseFloat(settings.RETINA_PREFIX?.exec(value)?.[1] ?? '1'),
                format: split[split.length - 2],
                src: value,
            };
        },
    },
    loader: {
        name: loaderName,
        extension: {
            type: ExtensionType.LoadParser,
            priority: LoaderParserPriority.Normal,
            name: loaderName,
        },
        test(url) {
            return checkExtension(url, ".atlas");
        },
        async load(url) {
            const response = await settings.ADAPTER.fetch(url);
            const txt = await response.text();
            return txt;
        },
        testParse(asset, options) {
            const isExtensionRight = checkExtension(options.src, ".atlas");
            const isString = typeof asset === "string";
            const isExplicitLoadParserSet = options.loadParser === loaderName;
            return Promise.resolve((isExtensionRight || isExplicitLoadParserSet) && isString);
        },
        unload(atlas) {
            atlas.dispose();
        },
        async parse(asset, options, loader) {
            const metadata = options.data || {};
            let basePath = utils.path.dirname(options.src);
            if (basePath && basePath.lastIndexOf("/") !== basePath.length - 1) {
                basePath += "/";
            }
            // Retval is going to be a texture atlas. However, we need to wait for its callback to resolve this promise.
            const retval = new TextureAtlas(asset);
            // If the user gave me only one texture, that one is assumed to be the "first" texture in the atlas
            if (metadata.images instanceof BaseTexture || typeof metadata.images === "string") {
                const pixiTexture = metadata.images;
                metadata.images = {};
                metadata.images[retval.pages[0].name] = pixiTexture;
            }
            // we will wait for all promises for the textures at the same time at the end.
            const textureLoadingPromises = [];
            // setting preferCreateImageBitmap to false for loadTextures loader to allow loading PMA images
            let oldPreferCreateImageBitmap = true;
            for (const parser of loader.parsers) {
                if (parser.name == "loadTextures") {
                    oldPreferCreateImageBitmap = parser.config?.preferCreateImageBitmap;
                    break;
                }
            }
            Assets.setPreferences({ preferCreateImageBitmap: false });
            // fill the pages
            for (const page of retval.pages) {
                const pageName = page.name;
                const providedPage = metadata?.images ? metadata.images[pageName] : undefined;
                if (providedPage instanceof BaseTexture) {
                    page.setTexture(SpineTexture.from(providedPage));
                }
                else {
                    const url = providedPage ?? utils.path.normalize([...basePath.split(utils.path.sep), pageName].join(utils.path.sep));
                    const assetsToLoadIn = { src: copySearchParams(url, options.src), data: { ...metadata.imageMetadata, ...{ alphaMode: page.pma ? ALPHA_MODES.PMA : ALPHA_MODES.UNPACK } } };
                    const pixiPromise = loader.load(assetsToLoadIn)
                        .then((texture) => {
                        page.setTexture(SpineTexture.from(texture.baseTexture));
                    });
                    textureLoadingPromises.push(pixiPromise);
                }
            }
            await Promise.all(textureLoadingPromises);
            // restoring preferCreateImageBitmap old value for loadTextures loader
            Assets.setPreferences({ preferCreateImageBitmap: oldPreferCreateImageBitmap });
            return retval;
        },
    },
};
extensions.add(spineTextureAtlasLoader);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXRsYXNMb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXNzZXRzL2F0bGFzTG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7K0VBMkIrRTtBQUUvRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRWxELE9BQU8sRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDeEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLGNBQWMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUVwRSxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFJbEcsTUFBTSxVQUFVLEdBQUcseUJBQXlCLENBQUM7QUFFN0MsTUFBTSx1QkFBdUIsR0FBaUU7SUFDN0YsU0FBUyxFQUFFLGFBQWEsQ0FBQyxLQUFLO0lBRTlCLFFBQVEsRUFBRTtRQUNULElBQUksRUFBRSxDQUFDLEtBQWEsRUFBVyxFQUFFLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUM7UUFDakUsS0FBSyxFQUFFLENBQUMsS0FBYSxFQUFtQixFQUFFO1lBQ3pDLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0IsT0FBTztnQkFDTixVQUFVLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDO2dCQUN2RSxNQUFNLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQixHQUFHLEVBQUUsS0FB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LENBQUMsQ0FBQyxDQUFDO29CQUNKLHNCQUFzQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDMUMsQ0FBQztZQUNGLENBQUM7WUFFRCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztZQUUxQyxzRUFBc0U7WUFDdEUsTUFBTSxDQUFDLGNBQWMsQ0FBQyxFQUFFLHVCQUF1QixFQUFFLDBCQUEwQixFQUFFLENBQUMsQ0FBQztZQUUvRSxPQUFPLE1BQU0sQ0FBQztRQUNmLENBQUM7S0FDRDtDQUMrRCxDQUFDO0FBRWxFLFVBQVUsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqIFNwaW5lIFJ1bnRpbWVzIExpY2Vuc2UgQWdyZWVtZW50XG4gKiBMYXN0IHVwZGF0ZWQgQXByaWwgNSwgMjAyNS4gUmVwbGFjZXMgYWxsIHByaW9yIHZlcnNpb25zLlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMy0yMDI1LCBFc290ZXJpYyBTb2Z0d2FyZSBMTENcbiAqXG4gKiBJbnRlZ3JhdGlvbiBvZiB0aGUgU3BpbmUgUnVudGltZXMgaW50byBzb2Z0d2FyZSBvciBvdGhlcndpc2UgY3JlYXRpbmdcbiAqIGRlcml2YXRpdmUgd29ya3Mgb2YgdGhlIFNwaW5lIFJ1bnRpbWVzIGlzIHBlcm1pdHRlZCB1bmRlciB0aGUgdGVybXMgYW5kXG4gKiBjb25kaXRpb25zIG9mIFNlY3Rpb24gMiBvZiB0aGUgU3BpbmUgRWRpdG9yIExpY2Vuc2UgQWdyZWVtZW50OlxuICogaHR0cDovL2Vzb3Rlcmljc29mdHdhcmUuY29tL3NwaW5lLWVkaXRvci1saWNlbnNlXG4gKlxuICogT3RoZXJ3aXNlLCBpdCBpcyBwZXJtaXR0ZWQgdG8gaW50ZWdyYXRlIHRoZSBTcGluZSBSdW50aW1lcyBpbnRvIHNvZnR3YXJlXG4gKiBvciBvdGhlcndpc2UgY3JlYXRlIGRlcml2YXRpdmUgd29ya3Mgb2YgdGhlIFNwaW5lIFJ1bnRpbWVzIChjb2xsZWN0aXZlbHksXG4gKiBcIlByb2R1Y3RzXCIpLCBwcm92aWRlZCB0aGF0IGVhY2ggdXNlciBvZiB0aGUgUHJvZHVjdHMgbXVzdCBvYnRhaW4gdGhlaXIgb3duXG4gKiBTcGluZSBFZGl0b3IgbGljZW5zZSBhbmQgcmVkaXN0cmlidXRpb24gb2YgdGhlIFByb2R1Y3RzIGluIGFueSBmb3JtIG11c3RcbiAqIGluY2x1ZGUgdGhpcyBsaWNlbnNlIGFuZCBjb3B5cmlnaHQgbm90aWNlLlxuICpcbiAqIFRIRSBTUElORSBSVU5USU1FUyBBUkUgUFJPVklERUQgQlkgRVNPVEVSSUMgU09GVFdBUkUgTExDIFwiQVMgSVNcIiBBTkQgQU5ZXG4gKiBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBFU09URVJJQyBTT0ZUV0FSRSBMTEMgQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVMsXG4gKiBCVVNJTkVTUyBJTlRFUlJVUFRJT04sIE9SIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0ZcbiAqIFRIRSBTUElORSBSVU5USU1FUywgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cblxuaW1wb3J0IHsgVGV4dHVyZUF0bGFzIH0gZnJvbSBcIkBlc290ZXJpY3NvZnR3YXJlL3NwaW5lLWNvcmVcIjtcbmltcG9ydCB7IFNwaW5lVGV4dHVyZSB9IGZyb20gXCIuLi9TcGluZVRleHR1cmUuanNcIjtcbmltcG9ydCB0eXBlIHsgQXNzZXRFeHRlbnNpb24sIExvYWRlciwgUmVzb2x2ZWRBc3NldCwgVW5yZXNvbHZlZEFzc2V0IH0gZnJvbSBcIkBwaXhpL2Fzc2V0c1wiO1xuaW1wb3J0IHsgQXNzZXRzLCBjb3B5U2VhcmNoUGFyYW1zIH0gZnJvbSBcIkBwaXhpL2Fzc2V0c1wiO1xuaW1wb3J0IHsgTG9hZGVyUGFyc2VyUHJpb3JpdHksIGNoZWNrRXh0ZW5zaW9uIH0gZnJvbSBcIkBwaXhpL2Fzc2V0c1wiO1xuaW1wb3J0IHR5cGUgeyBUZXh0dXJlIH0gZnJvbSBcIkBwaXhpL2NvcmVcIjtcbmltcG9ydCB7IEFMUEhBX01PREVTLCBFeHRlbnNpb25UeXBlLCBzZXR0aW5ncywgdXRpbHMsIEJhc2VUZXh0dXJlLCBleHRlbnNpb25zIH0gZnJvbSBcIkBwaXhpL2NvcmVcIjtcblxudHlwZSBSYXdBdGxhcyA9IHN0cmluZztcblxuY29uc3QgbG9hZGVyTmFtZSA9IFwic3BpbmVUZXh0dXJlQXRsYXNMb2FkZXJcIjtcblxuY29uc3Qgc3BpbmVUZXh0dXJlQXRsYXNMb2FkZXI6IEFzc2V0RXh0ZW5zaW9uPFJhd0F0bGFzIHwgVGV4dHVyZUF0bGFzLCBJU3BpbmVBdGxhc01ldGFkYXRhPiA9IHtcblx0ZXh0ZW5zaW9uOiBFeHRlbnNpb25UeXBlLkFzc2V0LFxuXG5cdHJlc29sdmVyOiB7XG5cdFx0dGVzdDogKHZhbHVlOiBzdHJpbmcpOiBib29sZWFuID0+IGNoZWNrRXh0ZW5zaW9uKHZhbHVlLCBcIi5hdGxhc1wiKSxcblx0XHRwYXJzZTogKHZhbHVlOiBzdHJpbmcpOiBVbnJlc29sdmVkQXNzZXQgPT4ge1xuXHRcdFx0Y29uc3Qgc3BsaXQgPSB2YWx1ZS5zcGxpdCgnLicpO1xuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0cmVzb2x1dGlvbjogcGFyc2VGbG9hdChzZXR0aW5ncy5SRVRJTkFfUFJFRklYPy5leGVjKHZhbHVlKT8uWzFdID8/ICcxJyksXG5cdFx0XHRcdGZvcm1hdDogc3BsaXRbc3BsaXQubGVuZ3RoIC0gMl0sXG5cdFx0XHRcdHNyYzogdmFsdWUsXG5cdFx0XHR9O1xuXHRcdH0sXG5cdH0sXG5cblx0bG9hZGVyOiB7XG5cdFx0bmFtZTogbG9hZGVyTmFtZSxcblx0XHRleHRlbnNpb246IHtcblx0XHRcdHR5cGU6IEV4dGVuc2lvblR5cGUuTG9hZFBhcnNlcixcblx0XHRcdHByaW9yaXR5OiBMb2FkZXJQYXJzZXJQcmlvcml0eS5Ob3JtYWwsXG5cdFx0XHRuYW1lOiBsb2FkZXJOYW1lLFxuXHRcdH0sXG5cblx0XHR0ZXN0ICh1cmw6IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRcdFx0cmV0dXJuIGNoZWNrRXh0ZW5zaW9uKHVybCwgXCIuYXRsYXNcIik7XG5cdFx0fSxcblxuXHRcdGFzeW5jIGxvYWQgKHVybDogc3RyaW5nKTogUHJvbWlzZTxSYXdBdGxhcz4ge1xuXHRcdFx0Y29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzZXR0aW5ncy5BREFQVEVSLmZldGNoKHVybCk7XG5cblx0XHRcdGNvbnN0IHR4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcblxuXHRcdFx0cmV0dXJuIHR4dDtcblx0XHR9LFxuXG5cdFx0dGVzdFBhcnNlIChhc3NldDogdW5rbm93biwgb3B0aW9uczogUmVzb2x2ZWRBc3NldCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuXHRcdFx0Y29uc3QgaXNFeHRlbnNpb25SaWdodCA9IGNoZWNrRXh0ZW5zaW9uKG9wdGlvbnMuc3JjISwgXCIuYXRsYXNcIik7XG5cdFx0XHRjb25zdCBpc1N0cmluZyA9IHR5cGVvZiBhc3NldCA9PT0gXCJzdHJpbmdcIjtcblx0XHRcdGNvbnN0IGlzRXhwbGljaXRMb2FkUGFyc2VyU2V0ID0gb3B0aW9ucy5sb2FkUGFyc2VyID09PSBsb2FkZXJOYW1lO1xuXG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKChpc0V4dGVuc2lvblJpZ2h0IHx8IGlzRXhwbGljaXRMb2FkUGFyc2VyU2V0KSAmJiBpc1N0cmluZyk7XG5cdFx0fSxcblxuXHRcdHVubG9hZCAoYXRsYXM6IFRleHR1cmVBdGxhcykge1xuXHRcdFx0YXRsYXMuZGlzcG9zZSgpO1xuXHRcdH0sXG5cblx0XHRhc3luYyBwYXJzZSAoYXNzZXQ6IFJhd0F0bGFzLCBvcHRpb25zOiB7IHNyYzogc3RyaW5nLCBkYXRhOiBJU3BpbmVBdGxhc01ldGFkYXRhIH0sIGxvYWRlcjogTG9hZGVyKTogUHJvbWlzZTxUZXh0dXJlQXRsYXM+IHtcblx0XHRcdGNvbnN0IG1ldGFkYXRhOiBJU3BpbmVBdGxhc01ldGFkYXRhID0gb3B0aW9ucy5kYXRhIHx8IHt9O1xuXHRcdFx0bGV0IGJhc2VQYXRoID0gdXRpbHMucGF0aC5kaXJuYW1lKG9wdGlvbnMuc3JjKTtcblxuXHRcdFx0aWYgKGJhc2VQYXRoICYmIGJhc2VQYXRoLmxhc3RJbmRleE9mKFwiL1wiKSAhPT0gYmFzZVBhdGgubGVuZ3RoIC0gMSkge1xuXHRcdFx0XHRiYXNlUGF0aCArPSBcIi9cIjtcblx0XHRcdH1cblxuXHRcdFx0Ly8gUmV0dmFsIGlzIGdvaW5nIHRvIGJlIGEgdGV4dHVyZSBhdGxhcy4gSG93ZXZlciwgd2UgbmVlZCB0byB3YWl0IGZvciBpdHMgY2FsbGJhY2sgdG8gcmVzb2x2ZSB0aGlzIHByb21pc2UuXG5cdFx0XHRjb25zdCByZXR2YWwgPSBuZXcgVGV4dHVyZUF0bGFzKGFzc2V0KTtcblxuXHRcdFx0Ly8gSWYgdGhlIHVzZXIgZ2F2ZSBtZSBvbmx5IG9uZSB0ZXh0dXJlLCB0aGF0IG9uZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBcImZpcnN0XCIgdGV4dHVyZSBpbiB0aGUgYXRsYXNcblx0XHRcdGlmIChtZXRhZGF0YS5pbWFnZXMgaW5zdGFuY2VvZiBCYXNlVGV4dHVyZSB8fCB0eXBlb2YgbWV0YWRhdGEuaW1hZ2VzID09PSBcInN0cmluZ1wiKSB7XG5cdFx0XHRcdGNvbnN0IHBpeGlUZXh0dXJlID0gbWV0YWRhdGEuaW1hZ2VzO1xuXHRcdFx0XHRtZXRhZGF0YS5pbWFnZXMgPSB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBCYXNlVGV4dHVyZSB8IHN0cmluZz47XG5cdFx0XHRcdG1ldGFkYXRhLmltYWdlc1tyZXR2YWwucGFnZXNbMF0ubmFtZV0gPSBwaXhpVGV4dHVyZTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gd2Ugd2lsbCB3YWl0IGZvciBhbGwgcHJvbWlzZXMgZm9yIHRoZSB0ZXh0dXJlcyBhdCB0aGUgc2FtZSB0aW1lIGF0IHRoZSBlbmQuXG5cdFx0XHRjb25zdCB0ZXh0dXJlTG9hZGluZ1Byb21pc2VzID0gW107XG5cblxuXHRcdFx0Ly8gc2V0dGluZyBwcmVmZXJDcmVhdGVJbWFnZUJpdG1hcCB0byBmYWxzZSBmb3IgbG9hZFRleHR1cmVzIGxvYWRlciB0byBhbGxvdyBsb2FkaW5nIFBNQSBpbWFnZXNcblx0XHRcdGxldCBvbGRQcmVmZXJDcmVhdGVJbWFnZUJpdG1hcCA9IHRydWU7XG5cdFx0XHRmb3IgKGNvbnN0IHBhcnNlciBvZiBsb2FkZXIucGFyc2Vycykge1xuXHRcdFx0XHRpZiAocGFyc2VyLm5hbWUgPT0gXCJsb2FkVGV4dHVyZXNcIikge1xuXHRcdFx0XHRcdG9sZFByZWZlckNyZWF0ZUltYWdlQml0bWFwID0gcGFyc2VyLmNvbmZpZz8ucHJlZmVyQ3JlYXRlSW1hZ2VCaXRtYXA7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdEFzc2V0cy5zZXRQcmVmZXJlbmNlcyh7IHByZWZlckNyZWF0ZUltYWdlQml0bWFwOiBmYWxzZSB9KTtcblxuXHRcdFx0Ly8gZmlsbCB0aGUgcGFnZXNcblx0XHRcdGZvciAoY29uc3QgcGFnZSBvZiByZXR2YWwucGFnZXMpIHtcblx0XHRcdFx0Y29uc3QgcGFnZU5hbWUgPSBwYWdlLm5hbWU7XG5cdFx0XHRcdGNvbnN0IHByb3ZpZGVkUGFnZSA9IG1ldGFkYXRhPy5pbWFnZXMgPyBtZXRhZGF0YS5pbWFnZXNbcGFnZU5hbWVdIDogdW5kZWZpbmVkO1xuXHRcdFx0XHRpZiAocHJvdmlkZWRQYWdlIGluc3RhbmNlb2YgQmFzZVRleHR1cmUpIHtcblx0XHRcdFx0XHRwYWdlLnNldFRleHR1cmUoU3BpbmVUZXh0dXJlLmZyb20ocHJvdmlkZWRQYWdlKSk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0Y29uc3QgdXJsOiBzdHJpbmcgPSBwcm92aWRlZFBhZ2UgPz8gdXRpbHMucGF0aC5ub3JtYWxpemUoWy4uLmJhc2VQYXRoLnNwbGl0KHV0aWxzLnBhdGguc2VwKSwgcGFnZU5hbWVdLmpvaW4odXRpbHMucGF0aC5zZXApKTtcblx0XHRcdFx0XHRjb25zdCBhc3NldHNUb0xvYWRJbiA9IHsgc3JjOiBjb3B5U2VhcmNoUGFyYW1zKHVybCwgb3B0aW9ucy5zcmMgYXMgc3RyaW5nKSwgZGF0YTogeyAuLi5tZXRhZGF0YS5pbWFnZU1ldGFkYXRhLCAuLi57IGFscGhhTW9kZTogcGFnZS5wbWEgPyBBTFBIQV9NT0RFUy5QTUEgOiBBTFBIQV9NT0RFUy5VTlBBQ0sgfSB9IH07XG5cdFx0XHRcdFx0Y29uc3QgcGl4aVByb21pc2UgPSBsb2FkZXIubG9hZDxUZXh0dXJlPihhc3NldHNUb0xvYWRJbilcblx0XHRcdFx0XHRcdC50aGVuKCh0ZXh0dXJlKSA9PiB7XG5cdFx0XHRcdFx0XHRcdHBhZ2Uuc2V0VGV4dHVyZShTcGluZVRleHR1cmUuZnJvbSh0ZXh0dXJlLmJhc2VUZXh0dXJlKSk7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR0ZXh0dXJlTG9hZGluZ1Byb21pc2VzLnB1c2gocGl4aVByb21pc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGF3YWl0IFByb21pc2UuYWxsKHRleHR1cmVMb2FkaW5nUHJvbWlzZXMpO1xuXG5cdFx0XHQvLyByZXN0b3JpbmcgcHJlZmVyQ3JlYXRlSW1hZ2VCaXRtYXAgb2xkIHZhbHVlIGZvciBsb2FkVGV4dHVyZXMgbG9hZGVyXG5cdFx0XHRBc3NldHMuc2V0UHJlZmVyZW5jZXMoeyBwcmVmZXJDcmVhdGVJbWFnZUJpdG1hcDogb2xkUHJlZmVyQ3JlYXRlSW1hZ2VCaXRtYXAgfSk7XG5cblx0XHRcdHJldHVybiByZXR2YWw7XG5cdFx0fSxcblx0fSxcbn0gYXMgQXNzZXRFeHRlbnNpb248UmF3QXRsYXMgfCBUZXh0dXJlQXRsYXMsIElTcGluZUF0bGFzTWV0YWRhdGE+O1xuXG5leHRlbnNpb25zLmFkZChzcGluZVRleHR1cmVBdGxhc0xvYWRlcik7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNwaW5lQXRsYXNNZXRhZGF0YSB7XG5cdC8vIElmIHlvdSBhcmUgZG93bmxvYWRpbmcgYW4gLmF0bGFzIGZpbGUsIHRoaXMgbWV0YWRhdGEgd2lsbCBnbyB0byB0aGUgVGV4dHVyZSBsb2FkZXJcblx0aW1hZ2VNZXRhZGF0YT86IGFueTtcblx0Ly8gSWYgeW91IGFscmVhZHkgaGF2ZSBhdGxhcyBwYWdlcyBsb2FkZWQgYXMgcGl4aSB0ZXh0dXJlcyBhbmQgd2FudCB0byB1c2UgdGhhdCB0byBjcmVhdGUgdGhlIGF0bGFzLCB5b3UgY2FuIHBhc3MgdGhlbSBoZXJlXG5cdGltYWdlcz86IEJhc2VUZXh0dXJlIHwgc3RyaW5nIHwgUmVjb3JkPHN0cmluZywgQmFzZVRleHR1cmUgfCBzdHJpbmc+O1xufVxuIl19